name: Deploy Workflow
on: deployment
jobs:
  deploy-ENVIRONMENT_NAME:
    name: Deploy to ENVIRONMENT_NAME environment
    if: ${{ github.event.deployment.environment }} == ENVIRONMENT_NAME
    concurrency: ENVIRONMENT_NAME
    permissions:
      deployments: write
      contents: read
    runs-on: ubuntu-latest
    container: miaplatform/mlp:2.1.0
    steps:
      - uses: actions/checkout@v4
      - name: Update deployment status (pending)
        if: success()
        uses: chrnorm/deployment-status@v2
        with:
          token: '${{ github.token }}'
          state: 'pending'
          deployment-id: ${{ github.event.deployment.id }}
      - name: Provision infrastructure with Terraform
        env:
          TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TERRAFORM_VERSION: 1.14.2
          TERRAFORM_WORK_DIR: ${{ github.workspace }}/terraform-work
          APPS_DIR: ${{ github.workspace }}/manifests/terraform/environments/${{ github.event.deployment.environment }}/app-service
        run: |
          echo "==> Installing Git"
          apk add --no-cache git
          
          echo "==> Configuring Git credentials for GitHub"
          git config --global url."https://x-access-token:${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"
          
          echo "==> Installing Terraform CLI ${TERRAFORM_VERSION}"
          wget -q https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip
          unzip -q terraform_${TERRAFORM_VERSION}_linux_amd64.zip
          mv terraform /usr/local/bin/
          rm terraform_${TERRAFORM_VERSION}_linux_amd64.zip
          terraform version
          
          echo "==> Configuring Terraform Cloud credentials"
          mkdir -p ~/.terraform.d
          cat > ~/.terraform.d/credentials.tfrc.json << EOF
          {
            "credentials": {
              "app.terraform.io": {
                "token": "${TF_API_TOKEN}"
              }
            }
          }
          EOF
          
          echo "==> Scanning for Terraform app configurations"
          VARS_FILES=$(find ${APPS_DIR} -maxdepth 1 -name "*.variables.tf" 2>/dev/null || true)
          
          if [ -z "$VARS_FILES" ]; then
            echo "No Terraform apps found in ${APPS_DIR}, skipping infrastructure provisioning"
            exit 0
          fi
          
          echo "Found $(echo "$VARS_FILES" | wc -l) app configuration(s):"
          for f in $VARS_FILES; do
            echo "  - $(basename $f)"
          done
          
          echo "==> Creating working directory: ${TERRAFORM_WORK_DIR}"
          mkdir -p ${TERRAFORM_WORK_DIR}
          cd ${TERRAFORM_WORK_DIR}
          
          echo "==> Generating main.tf header with HCP Terraform configuration"
          cat > main.tf << 'TFEOF'
          terraform {
            cloud {
              organization = "mia-platform"
              workspaces {
                name = "hcp-terraform-demo"
              }
            }
            required_providers {
              azurerm = {
                source  = "hashicorp/azurerm"
                version = "~> 3.0"
              }
            }
          }

          provider "azurerm" {
            features {}
          }
          TFEOF
          
          echo "==> Processing app configurations and generating module blocks"
          for VARS_FILE in $VARS_FILES; do
            BASENAME=$(basename "$VARS_FILE")
            MODULE_NAME="${BASENAME%.variables.tf}"
            
            echo ""
            echo "Processing app: $MODULE_NAME"
            echo "  Source file: $VARS_FILE"
            
            # Extract variable names from the file
            echo "  Extracting variable names..."
            VAR_NAMES=$(grep -E '^\s*variable\s+"' "$VARS_FILE" | sed -E 's/.*variable\s+"([^"]+)".*/\1/')
            VAR_COUNT=$(echo "$VAR_NAMES" | wc -w)
            echo "  Found $VAR_COUNT variable(s): $(echo $VAR_NAMES | tr '\n' ' ')"
            
            # Generate module block
            echo "  Generating module block..."
            echo "" >> main.tf
            echo "module \"${MODULE_NAME}\" {" >> main.tf
            echo "  source = \"git::https://github.com/Mia-Platform-Experiments/tf-azure-app-service.git\"" >> main.tf
            echo "" >> main.tf
            
            for VAR_NAME in $VAR_NAMES; do
              echo "    Mapping: ${VAR_NAME} = var.${MODULE_NAME}_${VAR_NAME}"
              echo "  ${VAR_NAME} = var.${MODULE_NAME}_${VAR_NAME}" >> main.tf
            done
            
            echo "}" >> main.tf
            
            # Transform and copy variables file with prefixed names
            echo "  Transforming variables file with prefix '${MODULE_NAME}_'..."
            sed -E \
              -e "s/variable \"([^\"]+)\"/variable \"${MODULE_NAME}_\1\"/" \
              -e "s/var\.([a-z_]+)/var.${MODULE_NAME}_\1/g" \
              "$VARS_FILE" > "${TERRAFORM_WORK_DIR}/${BASENAME}"
            echo "  Created: ${TERRAFORM_WORK_DIR}/${BASENAME}"
          done
          
          echo ""
          echo "==> Generated main.tf content:"
          cat main.tf
          
          echo ""
          echo "==> Transformed variables files in working directory:"
          ls -lah ${TERRAFORM_WORK_DIR}
          
          echo ""
          echo "==> Sample of transformed variables (first file):"
          head -20 ${TERRAFORM_WORK_DIR}/*.variables.tf | head -20
          
          echo "==> Initializing Terraform with HCP Terraform backend"
          terraform init
          
          echo "==> Planning infrastructure changes"
          terraform plan
          
          echo "==> Applying infrastructure changes"
          terraform apply -auto-approve
      - name: Deploy my app
        if: ${{ false }} # TEMPORARY DISABLE KUBERNETES DEPLOYMENT STEP
        env:
          GIT_DEPTH: 1
          ENVIRONMENT_VARIABLES_PREFIX: MIA_
          BASE_PATH: ${{ github.workspace }}/configuration
          OVERLAY_PATH: "${{ github.workspace }}/overlays/${{ github.event.deployment.environment }}"
          DESTINATION_PATH: "${{ github.workspace }}/interpolated-files"
          GENERATE_FILE: "${{ github.workspace }}/mlp.yaml"
          VARIABLES_FILE: "${{ github.workspace }}/overlays/${{ github.event.deployment.environment }}/variables.env"
          ENVIRONMENT_TO_DEPLOY: ${{ github.event.deployment.environment }}
          ENVIRONMENT_PREFIX: ${{ github.event.deployment.environment }}_
          DEPLOY_TYPE: ${{ github.event.deployment.payload.variables.DEPLOY_TYPE }}
          FORCE_DEPLOY_WHEN_NO_SEMVER: ${{ github.event.deployment.payload.variables.FORCE_DEPLOY_WHEN_NO_SEMVER }}
          KUBE_NAMESPACE: ${{ github.event.deployment.payload.variables.KUBE_NAMESPACE }}
          KUBE_URL: ${{ secrets.KUBE_URL }}
          KUBE_CA_PEM: ${{ secrets.KUBE_CA_PEM }}
          KUBE_TOKEN: ${{ secrets.KUBE_TOKEN }}
          NEXUS_USER: ${{ secrets.NEXUS_USER }}
          NEXUS_TOKEN: ${{ secrets.NEXUS_TOKEN }}
          NEXUS_URL: ${{ secrets.NEXUS_URL }}
        run: |
          export RELEASE_DATE="$(date -I'seconds' -u)"
          tee /tmp/ca.pem > /dev/null << EOF
          ${KUBE_CA_PEM}
          EOF
          mkdir ${DESTINATION_PATH}
          test -f "${VARIABLES_FILE}" && set -a && source "${VARIABLES_FILE}"
          test -f "${GENERATE_FILE}" && mlp generate -c "${GENERATE_FILE}" -e "${ENVIRONMENT_PREFIX}" -e "${ENVIRONMENT_VARIABLES_PREFIX}" -o "${OVERLAY_PATH}"
          mlp hydrate "${BASE_PATH}" "${OVERLAY_PATH}"
          mlp interpolate -e "${ENVIRONMENT_PREFIX}" -e "${ENVIRONMENT_VARIABLES_PREFIX}" -f "${BASE_PATH}" -o "${BASE_PATH}"
          mlp interpolate -e "${ENVIRONMENT_PREFIX}" -e "${ENVIRONMENT_VARIABLES_PREFIX}" -f "${OVERLAY_PATH}" -o "${OVERLAY_PATH}"
          mlp kustomize "${OVERLAY_PATH}" -o "${DESTINATION_PATH}/kustomize-output.yaml"
          mlp deploy --ensure-namespace=false --server "${KUBE_URL}" --certificate-authority "/tmp/ca.pem" --token "${KUBE_TOKEN}" --deploy-type "${DEPLOY_TYPE}" --force-deploy-when-no-semver="${FORCE_DEPLOY_WHEN_NO_SEMVER}" -f "${DESTINATION_PATH}/kustomize-output.yaml" -n "${KUBE_NAMESPACE}"
      - name: Update deployment status (success)
        if: success()
        uses: chrnorm/deployment-status@v2
        with:
          token: '${{ github.token }}'
          state: 'success'
          deployment-id: ${{ github.event.deployment.id }}
      - name: Update deployment status (failure)
        if: failure()
        uses: chrnorm/deployment-status@v2
        with:
          token: '${{ github.token }}'
          state: 'failure'
          deployment-id: ${{ github.event.deployment.id }}