name: Deploy Workflow
on: deployment
jobs:
  deploy-ENVIRONMENT_NAME:
    name: Deploy to ENVIRONMENT_NAME environment
    if: ${{ github.event.deployment.environment }} == ENVIRONMENT_NAME
    concurrency: ENVIRONMENT_NAME
    permissions:
      deployments: write
      contents: read
    runs-on: ubuntu-latest
    container: miaplatform/mlp:2.1.0
    steps:
      - uses: actions/checkout@v4
      - name: Update deployment status (pending)
        if: success()
        uses: chrnorm/deployment-status@v2
        with:
          token: '${{ github.token }}'
          state: 'pending'
          deployment-id: ${{ github.event.deployment.id }}
      - name: Provision infrastructure with Terraform
        env:
          TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TERRAFORM_VERSION: 1.6.6
          TERRAFORM_WORK_DIR: ${{ github.workspace }}/terraform-work
          VARIABLES_FILE_PATH: ${{ github.workspace }}/manifests/terraform/environments/${{ github.event.deployment.environment }}/app-service/my-azure-app-service.variables.tf
        run: |
          echo "==> Installing Git"
          apk add --no-cache git
          
          echo "==> Configuring Git credentials for GitHub"
          git config --global url."https://x-access-token:${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"
          
          echo "==> Installing Terraform CLI ${TERRAFORM_VERSION}"
          wget -q https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip
          unzip -q terraform_${TERRAFORM_VERSION}_linux_amd64.zip
          mv terraform /usr/local/bin/
          rm terraform_${TERRAFORM_VERSION}_linux_amd64.zip
          terraform version
          
          echo "==> Creating working directory: ${TERRAFORM_WORK_DIR}"
          mkdir -p ${TERRAFORM_WORK_DIR}
          cd ${TERRAFORM_WORK_DIR}
          
          echo "==> Generating main.tf with HCP Terraform configuration"
          cat > main.tf << 'EOF'
          terraform {
            cloud {
              organization = "mia-platform"
              workspaces {
                name = "hcp-terraform-demo"
              }
            }
          }

          module "my-azure-app-service" {
            source = "git::https://github.com/Mia-Platform-Experiments/tf-azure-app-service.git"
            
            service_name         = var.service_name
            resource_group_name  = var.resource_group_name
            location             = var.location
            performance_profile  = var.performance_profile
            tech_stack           = var.tech_stack
          }
          EOF
          
          echo "==> Generated main.tf content:"
          cat main.tf
          
          echo "==> Copying variables file from: ${VARIABLES_FILE_PATH}"
          cp ${VARIABLES_FILE_PATH} ${TERRAFORM_WORK_DIR}/
          ls -la ${TERRAFORM_WORK_DIR}
          
          echo "==> Initializing Terraform with HCP Terraform backend"
          terraform init
          
          echo "==> Planning infrastructure changes"
          terraform plan
          
          echo "==> Applying infrastructure changes"
          terraform apply -auto-approve
      - name: Deploy my app
        env:
          GIT_DEPTH: 1
          ENVIRONMENT_VARIABLES_PREFIX: MIA_
          BASE_PATH: ${{ github.workspace }}/configuration
          OVERLAY_PATH: "${{ github.workspace }}/overlays/${{ github.event.deployment.environment }}"
          DESTINATION_PATH: "${{ github.workspace }}/interpolated-files"
          GENERATE_FILE: "${{ github.workspace }}/mlp.yaml"
          VARIABLES_FILE: "${{ github.workspace }}/overlays/${{ github.event.deployment.environment }}/variables.env"
          ENVIRONMENT_TO_DEPLOY: ${{ github.event.deployment.environment }}
          ENVIRONMENT_PREFIX: ${{ github.event.deployment.environment }}_
          DEPLOY_TYPE: ${{ github.event.deployment.payload.variables.DEPLOY_TYPE }}
          FORCE_DEPLOY_WHEN_NO_SEMVER: ${{ github.event.deployment.payload.variables.FORCE_DEPLOY_WHEN_NO_SEMVER }}
          KUBE_NAMESPACE: ${{ github.event.deployment.payload.variables.KUBE_NAMESPACE }}
          KUBE_URL: ${{ secrets.KUBE_URL }}
          KUBE_CA_PEM: ${{ secrets.KUBE_CA_PEM }}
          KUBE_TOKEN: ${{ secrets.KUBE_TOKEN }}
          NEXUS_USER: ${{ secrets.NEXUS_USER }}
          NEXUS_TOKEN: ${{ secrets.NEXUS_TOKEN }}
          NEXUS_URL: ${{ secrets.NEXUS_URL }}
        run: |
          export RELEASE_DATE="$(date -I'seconds' -u)"
          tee /tmp/ca.pem > /dev/null << EOF
          ${KUBE_CA_PEM}
          EOF
          mkdir ${DESTINATION_PATH}
          test -f "${VARIABLES_FILE}" && set -a && source "${VARIABLES_FILE}"
          test -f "${GENERATE_FILE}" && mlp generate -c "${GENERATE_FILE}" -e "${ENVIRONMENT_PREFIX}" -e "${ENVIRONMENT_VARIABLES_PREFIX}" -o "${OVERLAY_PATH}"
          mlp hydrate "${BASE_PATH}" "${OVERLAY_PATH}"
          mlp interpolate -e "${ENVIRONMENT_PREFIX}" -e "${ENVIRONMENT_VARIABLES_PREFIX}" -f "${BASE_PATH}" -o "${BASE_PATH}"
          mlp interpolate -e "${ENVIRONMENT_PREFIX}" -e "${ENVIRONMENT_VARIABLES_PREFIX}" -f "${OVERLAY_PATH}" -o "${OVERLAY_PATH}"
          mlp kustomize "${OVERLAY_PATH}" -o "${DESTINATION_PATH}/kustomize-output.yaml"
          mlp deploy --ensure-namespace=false --server "${KUBE_URL}" --certificate-authority "/tmp/ca.pem" --token "${KUBE_TOKEN}" --deploy-type "${DEPLOY_TYPE}" --force-deploy-when-no-semver="${FORCE_DEPLOY_WHEN_NO_SEMVER}" -f "${DESTINATION_PATH}/kustomize-output.yaml" -n "${KUBE_NAMESPACE}"
      - name: Update deployment status (success)
        if: success()
        uses: chrnorm/deployment-status@v2
        with:
          token: '${{ github.token }}'
          state: 'success'
          deployment-id: ${{ github.event.deployment.id }}
      - name: Update deployment status (failure)
        if: failure()
        uses: chrnorm/deployment-status@v2
        with:
          token: '${{ github.token }}'
          state: 'failure'
          deployment-id: ${{ github.event.deployment.id }}